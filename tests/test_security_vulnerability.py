"""
Tests for security vulnerability fixes.
"""

import pytest
from pydantic import ValidationError

from troubleshooting_mcp.models import SafeCommandInput


class TestSecurityVulnerability:
    """Tests for specific security vulnerabilities."""

    def test_safe_command_argument_blocking(self):
        """Test that dangerous arguments are blocked."""

        # Test ping flood
        with pytest.raises(ValidationError) as exc:
            SafeCommandInput(command="ping", args=["-f", "google.com"])
        assert "Argument '-f' is not allowed" in str(exc.value)

        # Test dig file read
        with pytest.raises(ValidationError) as exc:
            SafeCommandInput(command="dig", args=["-f", "/etc/passwd"])
        assert "Argument '-f' is not allowed" in str(exc.value)

        # Test combined flags
        with pytest.raises(ValidationError) as exc:
            SafeCommandInput(command="ping", args=["-cf", "5", "google.com"])
        assert "Flag '-f' (in '-cf') is not allowed" in str(exc.value)

    def test_safe_command_allowed_args(self):
        """Test that safe arguments are still allowed."""
        # Ping with count should be fine
        model = SafeCommandInput(command="ping", args=["-c", "5", "google.com"])
        assert model.command == "ping"
        assert "-c" in model.args

        # Dig with type should be fine
        model = SafeCommandInput(command="dig", args=["A", "google.com"])
        assert model.command == "dig"
